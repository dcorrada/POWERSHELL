<#
Name......: Malwarebytes_wrapper.ps1
Version...: 22.04.1
Author....: Dario CORRADA

This script automatically fetch and install Malwarebytes, performs a scan job and then unistalls it

see also https://silentinstallhq.com/malwarebytes-install-and-uninstall-powershell/
#>

# elevated script execution with admin privileges
$currentUser = New-Object Security.Principal.WindowsPrincipal $([Security.Principal.WindowsIdentity]::GetCurrent())
$testadmin = $currentUser.IsInRole([Security.Principal.WindowsBuiltinRole]::Administrator)
if ($testadmin -eq $false) {
    Start-Process powershell.exe -Verb RunAs -ArgumentList ('-noprofile -file "{0}" -elevated' -f ($myinvocation.MyCommand.Definition))
    exit $LASTEXITCODE
}

# setting script execution policy
$ErrorActionPreference= 'SilentlyContinue'
Set-ExecutionPolicy -Scope LocalMachine -ExecutionPolicy Bypass -Force
$ErrorActionPreference= 'Inquire'

# graphical stuff
Add-Type -AssemblyName System.Windows.Forms
Add-Type -AssemblyName System.Drawing
Add-Type -AssemblyName PresentationFramework

Write-Host -ForegroundColor Blue "*** Malwarebytes ***`n"

# Download and install
Write-Host -NoNewline 'Download and install... '
$download = New-Object net.webclient
$downbin = 'C:\Users\' + $env:USERNAME + '\Downloads\mbinstall.exe'
if (Test-Path $downbin) {
    Remove-Item $downbin -Force    
}
$download.DownloadFile('https://data-cdn.mbamupdates.com/web/mb4-setup-consumer/MBSetup.exe', $downbin)
#Invoke-WebRequest -Uri 'https://data-cdn.mbamupdates.com/web/mb4-setup-consumer/MBSetup.exe' -OutFile $downbin
Start-Process -Wait -FilePath $downbin '/VERYSILENT /NORESTART'
Remove-Item $downbin -Force 
Write-Host -ForegroundColor Green "DONE`n"

# Finding binary
$apath = Get-ChildItem -Path 'C:\Program Files' -Filter 'mbam.exe' -Force -Recurse -ErrorAction SilentlyContinue
if ($apath) {
    $fullpath = $apath.DirectoryName
} else {
    $apath = Get-ChildItem -Path 'C:\Program Files (x86)' -Filter 'mbam.exe' -Force -Recurse -ErrorAction SilentlyContinue
    if ($apath) {
        $fullpath = $apath.DirectoryName
    } else {
        [System.Windows.MessageBox]::Show("Malwarebytes not found",'ERROR','Ok','Error') > $null
        Exit
    }
}

# Malwarebytes launch
Write-Host -NoNewline 'Perform... '
$thebin = $fullpath + '\mbam.exe'
Start-Process $thebin
[System.Windows.MessageBox]::Show("Click Ok to uninstall Malwarebytes",'UNINSTALL','Ok','Warning') > $null
Write-Host -ForegroundColor Green "DONE`n"

# Uninstall
Write-Host -NoNewline 'Uninstall... '
$ErrorActionPreference= 'SilentlyContinue'
$prey = Get-Process mbam
Stop-Process -Id $prey.Id -Force
$prey = Get-Process mbamtray
Stop-Process -Id $prey.Id -Force
Start-Sleep 2
$ErrorActionPreference= 'Inquire'
$unbin = $fullpath + '\mbuns.exe'
Start-Process -Wait $unbin '/VERYSILENT /NORESTART'
Write-Host -ForegroundColor Green "DONE`n"